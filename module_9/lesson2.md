# Урок 2. Проверка статистических гипотез

## Зачем нужны статистические гипотезы?

Представим, что компания, в которой мы работаем, провела редизайн сайта, чтобы пользователям было удобнее оформлять заказы. Ключевая метрика, на которую ориентируется руководство - конверсия. **Конверсия** - это процент людей, которые совершают какое-то целевое действие (клик по ссылке/покупка/скачивание файла) относительно общего трафика сайта. Например, если на сайт зашли 1000 человек и 50 оформили заказ, то конверсия будет 5%.

Как поступило руководство - посчитали общую конверсию за последний месяц работы сайта (пусть будет 3%), затем провели редизайн и через месяц еще раз посчитали конверсию (3.3%). Действительно ли это значимое изменение и теперь сайт позволяет продавать больше? Или это всего лишь случайное отклонение и в следующем месяце конверсия может выйти на старый уровень или даже ниже? Для того, чтобы однозначно отвечать на такие вопросы придумали проверку статистических гипотез.

## Нулевая и альтернативная гипотеза

Сначала формулируют две исключащие друг друга гипотезы. Нулевая гипотеза - базовое предположение. Обычно оно состоит в том, что из-за внесенных изменений ничего не изменится. Пусть $A_0$ - распределение конверсии до редизайна, а $A_1$ - распределение конверсии после редизайна, тогда нулевую гипотезу $H_0$ можно сформулировать так:

$$H_0: E[A_0] = E[A_1]$$

Или другими словами нулевая гипотеза состоит в том, что матожидания конверсий одинаковы до и после редизайна.

За альтернативную гипотезу $H_1$ обычно берут то, что нам бы хотелось доказать (то, на что мы рассчитываем). В нашем случае нам бы хотелось показать, что матожидание конверсий после редизайна увеличилось:

$$H_1: E[A_0] < E[A_1]$$

Альтернативную гипотезу можно сформулировать по-разному. Выше мы записали **левостороннюю** гипотезу. Если бы мы хотели доказать, что конверсия ухудшилась, то мы бы рассматривали **правостороннюю** гипотезу: $E[A_0] > E[A_1]$. Ну и если бы нам просто хотелось показать, что редизайн повлиял на конверсию (не важно в какую сторону), то мы бы формулировали **двустороннюю** гипотезу: $E[A_0] \neq E[A_1]$. Левостороннюю и правостороннюю гипотезу также называют **односторонними** гипотезами.

Статистический тест (или проверка гипотезы) состоит в том, что мы либо отвергаем нулевую гипотезу в пользу альтернативной, либо мы не можем отвергнуть нулевую гипотезу и остаемся с ней. Изначально гипотезы неравнозначны между собой. Интуитивно - нам сложнее отвергнуть нулевую гипотезу, чем остаться с ней (это же можно показать математически). Поэтому при постановке эксперимента важно правильно формулировать гипотезу.

## Алгоритм проверки гипотезы

В общем виде алгоритм выглядит так:

1. Формулируем гипотезы $H_0$ и $H_1$
2. Выбираем уровень значимости
3. Определяем и рассчитываем статистический критерий
4. Принимаем решение

Как сформулировать гипотезы мы уже разобрались, обсудим остальные пункты

### Выбираем уровень значимости

Что такое уровень значимости и зачем он нужен? Если очень просто, то это вероятность того, что мы совершим ошибку, отвергнув нулевую гипотезу. Обычно уровень значимости $\alpha$ берут 0.05. Но если вам нужен более достоверный результат, то можно выбрать уровень значимости меньше - например, 0.01 или 0.001.

### Определяем статистический критерий и рассчитываем его

В зависимости от того, какую гипотезу мы хотим проверить, мы можем использовать различные способы подсчета насколько результаты схожи или различны между собой. [Существует множество статистических критериев](https://ru.wikipedia.org/wiki/%D0%A1%D1%82%D0%B0%D1%82%D0%B8%D1%81%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9_%D0%BA%D1%80%D0%B8%D1%82%D0%B5%D1%80%D0%B8%D0%B9#%D0%92%D0%B8%D0%B4%D1%8B_%D0%BA%D1%80%D0%B8%D1%82%D0%B5%D1%80%D0%B8%D0%B5%D0%B2), среди которых наверняка будет хотя бы один, подходящий по вашу задачу.

В нашем примере с редизайном сайта нужно сравнить среднее значение двух величин. Если мы предположим, что значения конверсии распределены нормально (в какие-то дни конверсия высокая, в какие-то маленькая), то мы сможем использовать критерий Стьюдента. **Критерий Стьюдента** позволяет оценивать матожидание случайной величины и сравнивать его с константой (одновыборочный критерий), сравнивать матожидания двух выборов (двухвыборочный критерий) или сравнивать матожидания до и после проведения какого-то эксперимента (парный критерий). Для простоты давайте предположим, что наблюдения были независимы и собранная информация по обоим месяцам не связана друг с другом (посетители сайта друг друга не знают и все заходят на всего сайт один раз). Был месяц наблюдений до редизайна $X_1$, в котором было $n_1$ дней и месяц наблюдений после редизайна $X_2$ в котором было $n_2$ дней. Несмещенная дисперсия равна $s_1^2, s_2^2$ соответственно.

Тогда мы можем использоавть парный критерий Стюдента, который можно посчитать по формуле:

$$
T(X_1, X_2) =
\frac{\bar{X_1} - \bar{X_2}}
{\sqrt{
    \frac{s_1^2}{n_1} +
    \frac{s_2^2}{n_2}}}
$$

### Принимаем решение

Значение критерия - это случайная величина, которая зависит от выборки (значения в которой случайны и принадлежат некоторому распределению). Следовательно, значение критерия может иметь какое-то распределение.

Критерий Стьюдента имеет распределение Стьюдента (мы им уже пользовались когда оценивали доверительные интервалы). Следовательно, мы можем оценить, насколько адекватное получилось значение критерия. Мы рассчитывали критерий основываясь на предположении о верности гипотезы $H_0$, поэтому если значение будет слишком маленьким или слишком большим, то это будет означать, что такое значение маловероятно. Соответственно, нам либо очень повезло встретить такое значение, либо нулевая гипотеза неверна.

Давайте посмотрим на такой пример. Мы знаем, что по распределению Стьюдента 99% значений для 15 значений лежит в диапазоне $[-2.95; 2.95]$ (квантиль 0.005, так как половина площади уходит влево, а половина вправо). Соответственно, если результат теста $T=10$, то такое событие очень маловероятно и почти наверняка мы можем отвергнуть нулевую гипотезу. Однако если значение окажется внутри интервала (например, -1), то это будет означать, что мы не можем отвергнуть нулевую гипотезу, так как вероятность встретить такое значение не слишком маленькая.

В примере выше все значения вне отрезка $[-2.95, 2.95]$ являлись **критической областью**. То есть это область значения критерия, в которую мы не попадаем с заданным уровнем значимости $\alpha$ и мы должны отвергать нулевую гипотезу при попадании туда. Площадь под графиком распределения критерия над критической областью равен уровню значимости.

Если критерий двусторонний, то критическая область будет состоять из двух интервалов (как у нас в примере). Если односторонний, то такая область будет только с одной стороны. При одностороннем тесте нужно будет получить значение критерия немного выше, так как та же площадь критической области будет распределяться не по двум сторонам, а только по одной.

Также иногда вводят понятие **p-значения** (p-value). P-значение - это вероятность получить такое же или более экстремальное значение критерия, которое получилось. Возвращаясь к примеру выше, если мы получили значение критерия -2.95, то p-value будет равно в точности $0.01$.  Если получим значение меньше, то p-value будет меньше.

## Ошибки 1 и 2 рода

При тестировании гипотез можно совершить ошибки двух типов.

**Ошибка 1 рода** - ложно-положительный результат. Цифры говорят, что мы совершили открытие (отклонили нулевую гипотезу), но на самом деле это не так. В таком случае нам "повезло" и значение критерия попало в критическую область. Чтобы совершать меньше ошибок первого рода, можно устанавливать более строгий уровень значимости. По определению уровень значимости - это вероятность ошибки первого рода.

**Ошибка 2 рода** - это когда мы не смогли отклонить нулевую гипотезу, хотя она неверна. Такое может произойти из-за того, что мы установили слишком маленький уровень значимости.

**вставить картинку с беременным мужчиной**

Между ошибками 1 и 2 рода нужно искать компромисс. Изменяя уровень значимости, мы уменьшаем вероятность одной ошибки и увеличиваем вероятность другой.

## Закрепим материал

Итак, еще раз пройдемся по основным пунктам:

1. Формулируем гипотезу. Важно правильно выбрать гипотезу, а также сформулировать двусторонюю или одностороннюю альтернативу.
2. Выбираем уровень значимости. Уровень значимости - вероятность ошибки первого рода. Чем он меньше, тем обычно больше доверяют исследованию, ведь если даже при таком уровне нулевая гипотеза отвергается, то это значит, что она совсем не верна.
3. Выбираем статистический критерий. Для большинства задач уже сформулированы критерии. Для сравнения средних значений можно использовать критерий Стьюдента, для сравнения дисперсий подойдет критерий Фишера, а проверить вид распределения можно при помощи критерия Пирсона.
4. Принимаем решение. Если значение критерия оказалось в критической области, значит нужно отвергать нулевую гипотезу. Если значение не в критической области, то оставляем нулевую гипотезу. Также можно использовать p-value, и если оно оказалось меньше уровня значимости, то отвергаем нулевую гипотезу.

## Проверка распределения на нормальность

Многие методы статистики используют предположение, что распределение нормальное. Но как проверить, действительно ли распределение является нормальным или только похоже на него? Для этого нужно провести статистический тест. Существует несколько таких тестов:

- Критерий Шапиро-Уилка
- Критерий асимметрии
- Критерий эксцесса
- QQ-plot

Как работают первые три теста - не так важно, обычно просто ориентируются на p-value, которое выдает тест.

А вот про QQ-plot расскажем подробнее.

Можно нарисовать график, в котором по оси X нарисовать квантили по выборке, а по оси Y взять квантили теоретического нормального распределения. Если выборка взята из нормального распределения, то график будет выглядить как линия $y=x$. Если график не похож на прямую линию, то выборка не из нормального распределения. Обычно в выборке тяжелые хвосты и значения на краях далеки от необходимых.
